---
title: "Running model fits"
format:
  html:
    toc: true
    toc-title: "On this page"
    number-sections: true
    code-fold: false
    css: Styles/style.css
bibliography: Citations.bib
vignette: >
  %\VignetteIndexEntry{Running model fits}
  %\VignetteEngine{quarto}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo=F, message=F}
library(Pmetrics)

r_help <- function(pkg, name) {
    glue::glue("[`{name}`](https://rdrr.io/pkg/{pkg}/man/{name}.html)")
}

gh_help <- function(name) {

    glue::glue("[`{name}`](https://lapkb.github.io/Pmetrics/reference/{name}.html)")

}


custom_table <- function(tab){
  #system.file("extData", tab, package = "Pmetrics") %>%
    read.csv(file.path("Data",tab), na.strings = ".") %>% gt() %>%

    tab_style(
      style = list(
        cell_fill(color = "black"),
        cell_text(color = "white", weight = "bold")
      ),
      locations = cells_column_labels(everything())
    )
}
```

## Fitting data to models

In this section, we suggest a workflow to help you maintain organized
modeling projects.

### Setting up a Pmetrics project
<span class="legacy">Legacy</span></br><span class="r6">R6</span>

When beginning a new modeling project, it is convenient to use the
command `PMtree()`. This command will set up a new directory
in the current working directory named whatever you have included as the
"project name". 

```{r echo=T, eval=F, label=pm_tree}
PMtree("DrugX")
```

In the above example, a directory called "DrugX" will be created
in the current working directory in R, which you can check with the `getwd` function. Beneath the new DrugX directory, several subdirectories will
be also created.

* **Rscript** contains a skeleton R script to begin Pmetrics runs in the new project.
* **Runs** should contain all files required for a run (described next) and it will also contain the resulting numerically ordered run directories created after each Pmetrics NPAG or IT2B run.
* **Sim** can contain any files related to simulations
* **src** is a repository for original and manipulated source data files

You are free to edit this directory tree structure as you please, or make your
own entirely.

### Getting the required inputs to run Pmetrics

<span class="r6">R6</span>

There is a full tutorial encoded inside Pmetrics to teach new users the basic functionality of the whole package. To start that tutorial in R type:
```{r echo=T, eval=F, label=pm_tutorial}
library(Pmetrics)
PM_tutorial()
```
Follow the instructions prompted in the terminal.

To setup a R6 Pmetrics run, you must provide `PM_data()` and  `PM_model()` objects. Once created, it does not matter where the files (if there are any) are located on your system because Pmetrics will use those objects, not the files.



### Running the model to fit the data


Once the `PM_model()` object is created and compiled the `$fit()` method will execute the fit. Arguments for this method can be found in the help for `$fit` in `r gh_help("PM_model")`.

``` {r echo=T, eval=F, label=pm_fit_run}
# default run parameters
mod1$fit(data = dat1)

# change the cycle number from default 100
mod1$fit(data = dat1, cycles = 500)

# change the engine from default NPAG
mod1$fit(engine = "NPOD")
```


## Loading results after a completed run

After the execution is done, you can load the output into R using `PM_load()`. Note the underscore "_" to distinguish this function from the Legacy `PMload()`. The argument to the function is the run number which you wish to load, corresponding to a folder with the same number in your **Runs** folder (if you made one).

``` {r echo=T, eval=F, label=pm_load}
my_run <- PM_load(1)
```

This creates a `PM_result()` object called `my_run`. Detailed information about the different elements contained in the result object can be accessed via `?PM_result` or by typing the result object into the terminal.

After that, that object can be used to access the different elements of the results, for example:

``` {r echo=T, eval=F, label=pm_load_plots}
exRes <- PM_load(1)
exRes$final$plot() # see ?plot.PM_final
exRes$op$plot(type = "pop") # see ?plot.PM_op,
exRes$data$plot(
  overlay = F,
  line = list(pred = list(exRes$post, color = "green"), join = F),
  marker = list(symbol = "diamond-open", color = "blue"),
  log = T
) # see ?plot.PM_data
```


