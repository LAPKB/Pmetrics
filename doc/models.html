<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Models</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">.caption {
color: #777;
margin-top: 10px;
}
.legacy {
background-color: #98a4a6;
color: white;
text-shadow: 1px 1px black;
border-radius: 5px;
padding: 3px;
}
.r6 {
background-color: #5296d5;
color: white;
text-shadow: 1px 1px black;
border-radius: 5px;
padding: 3px;
}
.update {
background-color: #d65645;
color: white;
text-shadow: 1px 1px black;
border-radius: 5px;
padding: 3px;
}
.to-be-reviewed {
background-color: red;
color: white;
text-shadow: 1px 1px black;
padding: 3px;
}
.script {
font-family: Arial, Helvetica, sans-serif;
background-color: lightgrey;
color: #446e9b;
}
body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; }
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
color: #5296d5;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }
code > span.kw { color: #555; font-weight: bold; } code > span.dt { color: #902000; } code > span.dv { color: #40a070; } code > span.bn { color: #d14; } code > span.fl { color: #d14; } code > span.ch { color: #d14; } code > span.st { color: #d14; } code > span.co { color: #888888; font-style: italic; } code > span.ot { color: #007020; } code > span.al { color: #ff0000; font-weight: bold; } code > span.fu { color: #900; font-weight: bold; } code > span.er { color: #a61717; background-color: #e3d2d2; } </style>




</head>

<body>




<h1 class="title toc-ignore">Models</h1>



<div id="specifying-models-in-r6" class="section level2">
<h2>Specifying Models in R6</h2>
<p>In <span class="r6">R6</span> Pmetrics, use the <code>PM_model</code>
function to create models directly in R. There are two ways to do
this.</p>
<ul>
<li>The first method is to specify the name of a .txt model file in the
same format as for <a href="#specifying-models-in-legacy">Legacy
Models</a></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>mod1 <span class="ot">&lt;-</span> PM_model<span class="sc">$</span><span class="fu">new</span>(<span class="st">&quot;model.txt&quot;</span>) </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#assumes model.txt is in working directory</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">#check with list.files() and/or getwd()</span></span></code></pre></div>
<ul>
<li>The second way is to create a list in R. Blocks in the Legacy
model.txt files which were delimited with the “#” character become lists
in R6.</li>
</ul>
<p>The R6 list model components are:</p>
<ul>
<li><a href="#priR6">PRImary</a></li>
<li><a href="#covR6">COVariate</a></li>
<li><a href="#secR6">SECondary</a></li>
<li><a href="#bolR6">BOLus</a></li>
<li><a href="#iniR6">INItial conditions</a></li>
<li><a href="#FaR6">F (bioavailability)</a></li>
<li><a href="#lagR6">LAG time</a></li>
<li><a href="#diffR6">DIFferential equations</a></li>
<li><a href="#outR6">OUTputs</a></li>
</ul>
<div id="priR6" class="section level3">
<h3>PRImary variables</h3>
<p>Primary variables are the model parameters that are to be estimated
by Pmetrics or are designated as fixed parameters with user specified
values. It should be a list of variable names, one name to a line.
Variable names should be 11 characters or fewer. Some variable names are
<a href="#reserved">reserved</a> for use by Pmetrics and cannot be used
as primary variable names. <strong>The number of primary variables must
be between 2 and 32, with at most 30 random or 20 fixed.</strong></p>
<p>Each variable can be specified by <code>ab</code> or
<code>msd</code>. The first defines the absolute search space for that
parameter for NPAG/NPOD, i.e., the range. For IT2B/RPEM, it defines the
mean of the prior as the midpoint of the range, and the range covers 6
standard deviations, e.g. ±3 SD above and below the mean, or 99.7% of
the prior distribution. <code>msd</code> is the companion function that
specifies a mean and SD in IT2B and RPEM. For NPAG/NPOD, it will be
converted in to a range in the reverse fashion as described for
<code>ab</code>. For both specifying functions, <code>gtz</code> is an
argument to force the parameter value to be positive,
i.e. <code>gtz=T</code>, which is the default. To allow negative
parameters, set <code>gtz=F</code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> PM_model<span class="sc">$</span><span class="fu">new</span>(<span class="fu">list</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">pri =</span> <span class="fu">list</span>(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ke =</span> <span class="fu">ab</span>(<span class="dv">0</span>,<span class="dv">5</span>),</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">V =</span> <span class="fu">msd</span>(<span class="dv">100</span>,<span class="dv">20</span>),</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">eff =</span> <span class="fu">ab</span>(<span class="sc">-</span><span class="dv">2</span>,<span class="dv">2</span>,<span class="at">gtz=</span>F)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>))</span></code></pre></div>
</div>
<div id="covR6" class="section level3">
<h3>COVariates</h3>
<p>Covariates are subject-specific data, such as body weight, contained
in the data .csv file. The covariate names, which are the column names
in the data file, must be declared, even if not used in the model
object. Once declared, they can be used in secondary variable and
differential equations. The order and names should be the same as in the
data file.</p>
<p>Covariates are applied at each dose event. The first dose event for
each subject must have a value for every covariate in the data file.</p>
<p><span class="update">Update</span> By default, missing covariate
values for subsequent dose events are linearly interpolated between
existing values, or carried forward if the first value is the only
non-missing entry.</p>
<p>To specify a new covariate value at a time other than a dose, enter a
dose event in the data file with 0 dose amount and the new covariate
value.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> PM_model<span class="sc">$</span><span class="fu">new</span>(<span class="fu">list</span>(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">pri =</span> <span class="fu">list</span>(...),</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">cov =</span> <span class="fu">list</span>(<span class="st">&quot;wt&quot;</span>,<span class="st">&quot;age&quot;</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>))</span></code></pre></div>
</div>
<div id="secR6" class="section level3">
<h3>SECondary variables</h3>
<p>Secondary variables are those that are defined by equations that are
combinations of primary, covariates, and other secondary variables. If
using other secondary variables, define them first within this block.
Equation syntax must be Fortran. Specify each variable equation as a
character vector. It is permissible to have conditional statements, but
because expressions in this block are translated into variable
declarations in Fortran, expressions other than of the form &quot;X =
function(Y)&quot; must be on a new line, prefixed by &quot;&amp;&quot; and contain only
variables which have been previously defined in the Primary, Covariate,
or Secondary blocks.</p>
<p>In the example below, V0 is the primary parameter which will be
estimated, but internally, the model uses V as V0*wt, unless age is
&gt;18, in which case weight is capped at 75 kg. It’s the same for CL0.
Note that the conditional statement is not named.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> PM_model<span class="sc">$</span><span class="fu">new</span>(<span class="fu">list</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">pri =</span> <span class="fu">list</span>(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">CL0 =</span> <span class="fu">ab</span>(<span class="dv">0</span>,<span class="dv">5</span>),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">V0 =</span> <span class="fu">msd</span>(<span class="dv">10</span>,<span class="dv">3</span>),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">eff =</span> <span class="fu">ab</span>(<span class="sc">-</span><span class="dv">2</span>,<span class="dv">2</span>,<span class="at">gtz=</span>F)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">cov =</span> <span class="fu">list</span>(<span class="st">&quot;wt&quot;</span>,<span class="st">&quot;age&quot;</span>),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">sec =</span> <span class="fu">list</span>(</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">V =</span> <span class="st">&quot;V0*wt&quot;</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;&amp;IF(age &gt;18) V = V0 * 75&quot;</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">CL =</span> <span class="st">&quot;CL0 * wt&quot;</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>))</span></code></pre></div>
</div>
<div id="bolR6" class="section level3">
<h3>BOLus inputs</h3>
<p>By default, inputs with DUR (duration) of 0 in the data .csv file are
“delivered” instantaneously to the model compartment equal to the input
number, i.e. input 1 goes to compartment 1, input 2 goes to compartment
2, etc. This can be overridden with NBCOMP(input number) = compartment
number.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> PM_model<span class="sc">$</span><span class="fu">new</span>(<span class="fu">list</span>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">bol =</span> <span class="fu">list</span>(<span class="st">&quot;NBCOMP(1) = 2&quot;</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>))</span></code></pre></div>
</div>
<div id="iniR6" class="section level3">
<h3>INItial conditions</h3>
<p>By default, all model compartments have zero amounts at time 0. This
can be changed by specifying the compartment amount as X(.) =
expression, where “.” is the compartment number. Primary and secondary
variables and covariates may be used in the expression, as can
conditional statements in Fortran code. An “&amp;” continuation prefix
is not necessary in this block for any statement, although if present,
will be ignored.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> PM_model<span class="sc">$</span><span class="fu">new</span>(<span class="fu">list</span>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">pri =</span> <span class="at">pri =</span> <span class="fu">list</span>(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ke =</span> <span class="fu">ab</span>(<span class="dv">0</span>,<span class="dv">5</span>),</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">V =</span> <span class="fu">msd</span>(<span class="dv">100</span>,<span class="dv">30</span>),</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">IC3 =</span> <span class="fu">ab</span>(<span class="dv">0</span>,<span class="dv">1000</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">cov =</span> <span class="fu">list</span>(<span class="st">&quot;wt&quot;</span>,<span class="st">&quot;age&quot;</span>,<span class="st">&quot;IC2&quot;</span>),</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">ini =</span> <span class="fu">list</span>(</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">X2 =</span> <span class="st">&quot;IC2*V&quot;</span>,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">X3 =</span> <span class="st">&quot;IC3&quot;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>))</span></code></pre></div>
<p>In the example above, IC is a covariate with the measured trough
concentration prior to an observed dose and IC3 is a fitted primary
parameter specifying an initial amount in unobserved compartment 3.</p>
<p>In the first case, the initial condition for compartment 2 becomes
the value of the IC covariate (defined in <code>cov</code> list)
multiplied by the current estimate of V during each iteration. This is
useful when a subject has been taking a drug as an outpatient, and comes
in to the lab for PK sampling, with measurement of a concentration
immediately prior to a witnessed dose, which is in turn followed by more
sampling. In this case, IC or any other covariate can be set to the
initial measured concentration, and if V is the volume of compartment 2,
the initial condition (amount) in compartment 2 will now be set to the
measured concentration of drug multiplied by the estimated volume for
each iteration until convergence.</p>
<p>In the second case, the initial condition for compartment 3 becomes
another variable, IC3 defined in the <code>pri</code> list, to fit in
the model, given the observed data.</p>
</div>
<div id="FaR6" class="section level3">
<h3>FA (bioavailability)</h3>
<p>Specify the bioavailability term, if present. Use the form FA(.) =
expression, where “.” is the input number. Primary and secondary
variables and covariates may be used in the expression, as can
conditional statements in Fortran code. An “&amp;” continuation prefix
is not necessary in this block for any statement, although if present,
will be ignored.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> PM_model<span class="sc">$</span><span class="fu">new</span>(<span class="fu">list</span>(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">pri =</span> <span class="at">pri =</span> <span class="fu">list</span>(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ke =</span> <span class="fu">ab</span>(<span class="dv">0</span>,<span class="dv">5</span>),</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">V =</span> <span class="fu">msd</span>(<span class="dv">100</span>,<span class="dv">30</span>),</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">FA1 =</span> <span class="fu">ab</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">fa =</span> <span class="fu">list</span>(</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">fa1 =</span> <span class="st">&quot;FA1&quot;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="lagR6" class="section level3">
<h3>LAG time</h3>
<p>Specify the lag term, if present, which is the delay after an
absorbed dose before observed concentrations. Use the form TLAG(.) =
expression, where “.” is the input number. Primary and secondary
variables and covariates may be used in the expression, as can
conditional statements in Fortran code. An “&amp;” continuation prefix
is not necessary in this block for any statement, although if present,
will be ignored.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> PM_model<span class="sc">$</span><span class="fu">new</span>(<span class="fu">list</span>(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">pri =</span> <span class="at">pri =</span> <span class="fu">list</span>(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ke =</span> <span class="fu">ab</span>(<span class="dv">0</span>,<span class="dv">5</span>),</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">V =</span> <span class="fu">msd</span>(<span class="dv">100</span>,<span class="dv">30</span>),</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag1 =</span> <span class="fu">ab</span>(<span class="dv">0</span>,<span class="dv">4</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">lag =</span> <span class="fu">list</span>(<span class="at">tlag1 =</span> <span class="st">&quot;lag1&quot;</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="differential-equations" class="section level3">
<h3>Differential equations</h3>
<p>Specify a model in terms of ordinary differential equations, in
Fortran format. XP(.) is the notation for dX(.)/dt, where “.” is the
compartment number. X(.) is the amount in the compartment. <strong>There
can be a maximum of 20 such equations.</strong></p>
<p>Specify equations as elements in a list, with XP(1) replaced by XP1,
for example, to name the list, and the list value a character vector in
Fortran.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> PM_model<span class="sc">$</span><span class="fu">new</span>(<span class="fu">list</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">pri =</span> <span class="at">pri =</span> <span class="fu">list</span>(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ka =</span> <span class="fu">ab</span>(<span class="dv">0</span>,<span class="dv">5</span>),</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ke =</span> <span class="fu">ab</span>(<span class="dv">0</span>,<span class="dv">5</span>),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">V =</span> <span class="fu">msd</span>(<span class="dv">100</span>,<span class="dv">30</span>),</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Kcp =</span> <span class="fu">ab</span>(<span class="dv">0</span>,<span class="dv">5</span>),</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">Kpc =</span> <span class="fu">ab</span>(<span class="dv">0</span>,<span class="dv">5</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">diff =</span> <span class="fu">list</span>(</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">xp1 =</span> <span class="st">&quot;-Ka * X(1)&quot;</span>,</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">xp2 =</span> <span class="st">&quot;RATEIV(1) + Ka * X(1) - (Ke + Kcp) * X(2) + Kpc * X(3)&quot;</span>,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">xp3 =</span> <span class="st">&quot;Kcp * X(2) - Kpc * X(3)&quot;</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>))</span></code></pre></div>
<p>RATEIV(1) is the notation to indicate an infusion of input 1
(typically drug 1). The duration of the infusion and total dose is
defined in the data.csv file. <strong>Up to 7 inputs are currently
allowed.</strong> These can be used in the model file as RATEIV(1),
RATEIV(2), etc. The compartments for receiving the inputs of oral
(bolus) doses are defined in the <code>bol</code> list, but can be
accessed by using the B(1), B(2), etc. notation in equations.</p>
</div>
<div id="outR6" class="section level3">
<h3>OUTputs</h3>
<p>Output equations are in Fortran format. Outputs are of the form Y(.)
= expression, where “.” is the output equation number. Primary and
secondary variables and covariates may be used in the expression, as can
conditional statements in Fortran code. An “&amp;” continuation prefix
is not necessary in this block for any statement, although if present,
will be ignored. <strong>There can be a maximum of 6
outputs.</strong></p>
<p>They are referred to as Y(1), Y(2), etc. These equations may also
define a model explicitly as a function of primary and secondary
variables and covariates.</p>
<p>The <code>out</code> list is a series of nested lists. The outer list
defines all the outputs. The next level defines each output equation.
Within the equation list is the equation and the error model. Within the
error model for that output, is the last list comprising model and assay
error specifications.</p>
<ul>
<li>To name output equations, Y(1) is replaced by Y1</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y1 =</span> <span class="fu">list</span>(...)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<ul>
<li>The output equation is a character vector followed by an error
list.</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y1 =</span> <span class="fu">list</span>(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;X(1)/V&quot;</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">err =</span> <span class="fu">list</span>(...)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<ul>
<li>The error model for an output equation has two elements. The first
is the <code>model</code> error, which can be one of three functions:
<code>proportional</code>, <code>additive</code>, or
<code>combination</code>. The arguments to these functions are a number
and optionally <code>fixed</code>, which defaults to <code>FALSE</code>.
If <code>fixed</code> is <code>FALSE</code>, the number serves as the
starting estimate for the model error. If <code>fixed</code> is
<code>TRUE</code>, the number serves as the model error, with no
estimation. Note that you can only fix the additive model currently to
zero.</li>
</ul>
<p>The second element is the <code>assay</code> error model. It is a
vector of 4 numbers that define a polynomial equation to permit
calculation of the standard deviation of an observation, based on the
noise of the asaay. The four terms estimate SD according to the folowing
equation: <span class="math inline">\(C0 + C1 * [obs] + C2 * [obs]^2 +
C3 * [obs]^3\)</span> and <span class="math inline">\([obs]\)</span> is
the observation. The values for the coefficients should ideally come
from the analytic lab in the form of inter-run standard deviations or
coefficients of variation at standard concentrations. You can use the
Pmetrics function <code>makeErrorPoly()</code> to choose the best set of
coefficients that fit the data from the laboratory. <span class="update">To be done:</span>Alternatively, if you have no
information about the assay, you can use the Pmetrics
<code>ERRrun()</code> engine as an argument to the <code>run</code>
function for <code>PM_fit</code> objects (i.e.,
<code>$run(engine=&quot;err&quot;)</code>) to estimate the coefficients from the
data. Finally, you can use a generic set of coefficients. We recommend
that as a start, <span class="math inline">\(C0\)</span> be set to half
of the lowest concentration in the dataset and <span class="math inline">\(C1\)</span> be set to 0.1. <span class="math inline">\(C2\)</span> and <span class="math inline">\(C3\)</span> can be 0.</p>
<p>The proportional model weights each observation by <span class="math inline">\(1/(\gamma * SD)^2\)</span>, where <span class="math inline">\(\gamma\)</span> is either fixed or estimated. The
additive model weights each observation by <span class="math inline">\(1/(\lambda + SD)^2\)</span>, where <span class="math inline">\(\lambda\)</span> is either fixed or estimated. The
combination model uses <span class="math inline">\(1/((\gamma * SD)^2 +
(\lambda + SD)^2)\)</span>.</p>
<p>In the proportional model, <span class="math inline">\(\gamma\)</span> is a scalar on assay SD. In
general, well-designed and executed studies and models with low
mis-specification will have data with <span class="math inline">\(\gamma\)</span> values approaching 1. Values &lt;1
suggest over-inflated assay noise. Poor quality, noisy data will result
in <span class="math inline">\(\gamma\)</span> of 5 or more. A good
starting value for <span class="math inline">\(\gamma\)</span> is
usually 5, and sometimes 10 if data are particularly complex or
noisy.</p>
<p>In the additive model, <span class="math inline">\(\lambda\)</span>
is additive to assay SD. In general, well-designed and executed studies
and models with low mis-specification will have data with <span class="math inline">\(\lambda\)</span> values approaching 0. Values of 0
may suggest over inflated assay noise. Poor quality, noisy data will
result in <span class="math inline">\(\lambda\)</span> of <span class="math inline">\(5*C0\)</span> or more. A good starting value for
<span class="math inline">\(\lambda\)</span> is usually <span class="math inline">\(3*C0\)</span>. Note, that <span class="math inline">\(C0\)</span> should generally not be 0, as it
represents machine noise (e.g. HPLC or mass spectrometer) that is always
present.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y1 =</span> <span class="fu">list</span>(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;X(1)/V&quot;</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">err =</span> <span class="fu">list</span>(</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">model =</span> <span class="fu">proportional</span>(<span class="dv">1</span>),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">assay =</span> <span class="fu">c</span>(<span class="fl">0.15</span>, <span class="fl">0.1</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y1 =</span> <span class="fu">list</span>(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;X(1)/V&quot;</span>,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">err =</span> <span class="fu">list</span>(</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">model =</span> <span class="fu">additive</span>(<span class="dv">1</span>, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">assay =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>More complete examples.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> PM_model<span class="sc">$</span><span class="fu">new</span>(<span class="fu">list</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">pri =</span> <span class="at">pri =</span> <span class="fu">list</span>(</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ke =</span> <span class="fu">ab</span>(<span class="dv">0</span>,<span class="dv">5</span>),</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">V =</span> <span class="fu">msd</span>(<span class="dv">100</span>,<span class="dv">30</span>),</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">out =</span> <span class="fu">list</span>(</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y1 =</span> <span class="fu">list</span>(</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;X(1)/V&quot;</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">err =</span> <span class="fu">list</span>(</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> <span class="fu">proportional</span>(<span class="dv">5</span>),</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">assay =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>mod2 <span class="ot">&lt;-</span> PM_model<span class="sc">$</span><span class="fu">new</span>(<span class="fu">list</span>(</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">pri =</span> <span class="at">pri =</span> <span class="fu">list</span>(</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">kin =</span> <span class="fu">ab</span>(<span class="dv">0</span>,<span class="dv">5</span>),</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">kout =</span> <span class="fu">ab</span>(<span class="dv">0</span>,<span class="dv">5</span>),</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">tpd =</span> <span class="fu">ab</span>(<span class="dv">0</span>,<span class="dv">5</span>),</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">V =</span> <span class="fu">msd</span>(<span class="dv">100</span>,<span class="dv">30</span>),</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">sec =</span> <span class="fu">list</span>(<span class="st">&quot;RES = B(1) * KIN/(KIN-KOUT) * (EXP(-KOUT*TPD)-EXP(-KIN*TPD))&quot;</span>),</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">out =</span> <span class="fu">list</span>(</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">y1 =</span> <span class="fu">list</span>(</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;RES/V&quot;</span>,</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">err =</span> <span class="fu">list</span>(</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">model =</span> <span class="fu">combination</span>(<span class="fl">0.4</span>,<span class="dv">3</span>) <span class="co">#additive, proportional</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">assay =</span> <span class="fu">c</span>(<span class="fl">0.3</span>, <span class="fl">0.15</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>))</span></code></pre></div>
<p>This last example is known as the Bateman equation for a model with
linear absorption (KIN) into and elimination (KOUT) from a central
compartment, and a time post-dose (TPD) or lag time. Here B(1) is the
oral bolus dosing vector for drug 1, and V is the volume of the central
compartment.</p>
</div>
</div>
<div id="updating-models-in-r6" class="section level2">
<h2>Updating Models in R6</h2>
<p>Because models are loaded as memory items in R6 Pmetrics, they can be
modified in R without having to edit text files. This function is
accessed via the <code>$update()</code> method for <code>PM_model</code>
objects.</p>
<p>All R6 objects are mini-environments, so direct copies of an R6
environment are in the same environment and changes to one will change
them all. This means the following code will likely not work as
intended.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>mod2 <span class="ot">&lt;-</span> mod1</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>mod2<span class="sc">$</span><span class="fu">update</span>(...)</span></code></pre></div>
<p>When <em>mod2</em> is updated, mod1 will update as they are in the
same environment. The way to create an independent copy of an R6 object,
which does not share the same environment, is to use the
<code>$clone()</code> method.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>mod2 <span class="ot">&lt;-</span> mod1<span class="sc">$</span><span class="fu">clone</span>()</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>mod2<span class="sc">$</span><span class="fu">update</span>(...)</span></code></pre></div>
<p>Now changes to mod2 do not propagate to mod1.</p>
<p>To update a model, simply supply the list items you wish to change
with the new values.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>mod2<span class="sc">$</span><span class="fu">update</span>(<span class="fu">list</span>(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">pri =</span> <span class="fu">list</span>(<span class="at">Ke =</span> <span class="fu">ab</span>(<span class="dv">1</span>,<span class="dv">3</span>),</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">V =</span> <span class="cn">NULL</span>,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">V0 =</span> <span class="fu">ab</span>(<span class="dv">0</span>, <span class="dv">20</span>)),</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">sec =</span> <span class="fu">list</span>(<span class="at">V =</span> <span class="st">&quot;V0 * wt&quot;</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>))</span></code></pre></div>
<p>This example changes the range of <em>Ke</em>, deletes <em>V</em>,
adds <em>V0</em>, and defines a new secondary relationship for <em>V =
V0 * wt</em>.</p>
</div>
<div id="specifying-models-in-legacy" class="section level2">
<h2>Specifying Models in Legacy</h2>
<p><span class="legacy">Legacy</span> models are only text files. All
the following also apply when using a model text file with
<code>PM_model()</code> in R6 Pmetrics. In either R6 or Legacy Pmetrics,
models are ultimately translated into Fortran text files with a header
version of TSMULT...</p>
<p>However, after Pmetrics version 0.30, we adopted a very simple user
format that Pmetrics will use to generate the Fortran code automatically
for you. Version 0.4 additionally eliminated the previously separate
instruction file. A model library is available on our website at <a href="http://www.lapk.org/pmetrics.php">http://www.lapk.org/pmetrics.php</a>.</p>
<p><strong>Naming your model files.</strong> The default model file name
is “model.txt,” but you can call them whatever you wish. However,
<strong>please keep the number of characters in the model file name ≤
8</strong>. When you use a model file in <code>NPrun()</code>,
<code>ITrun()</code>, <code>ERRrun()</code>, or <code>SIMrun()</code>,
Pmetrics will make a Fortran model file of the same name, temporarily
renaming your file. At the end of the run, your original model file will
be in the /inputs subfolder of the run folder, and the generated Fortran
model file will be called “model.for” and moved to the /etc subfolder of
the run folder. If your model is called “mymodel.txt”, then the Fortran
file will be “mymodel.for”.</p>
<p>You can still use appropriate Fortran model files directly, but we
suggest you keep the .for extension for all Fortran files to avoid
confusion with the new format. If you use a .for file as your model, you
will have to specify its name explicitly in <code>NPrun()</code>,
<code>ITrun()</code>, <code>ERRrun()</code>, or <code>SIMrun()</code>,
since the default model name again is “model.txt.” If you use a .for
file directly, it will be in the /inputs subfolder of the run folder,
not in /etc, since you did not use the simpler template as your model
file.</p>
<p><strong>Structure of model files.</strong> The model file is a text
file with 11 blocks, each marked by &quot;#&quot; followed by a header tag. Only
details which are different than the R6 documentation are included
below.</p>
<ul>
<li><a href="#pri">#PRImary variables</a></li>
<li><a href="#cov">#COVariates</a></li>
<li><a href="#sec">#SECcondary variables</a></li>
<li><a href="#bol">#BOLus inputs</a></li>
<li><a href="#ini">#INItial conditions</a></li>
<li><a href="#fa">#Fa (bioavailability)</a></li>
<li><a href="#lag">#LAG time</a></li>
<li><a href="#dif">#DIFferential equations</a></li>
<li><a href="#out">#OUTputs</a></li>
<li><a href="#err">#ERRor</a></li>
<li><a href="#extra">#EXTra</a></li>
</ul>
<p>For each header, only the capital letters are required for
recognition by Pmetrics. The blocks can be in any order, and header
names are case-insensitive (i.e. the capitalization here is just to show
which letters are required). Fortran is also case-insensitive, so in
variable names and expressions case is ignored. Details of each block
are next, followed by a <a href="#completeEx">complete example</a>.</p>
<p>Important: Sometimes it is important to preserve spacing and
formatting in Fortran code that you might insert into blocks,
particularly the #EXTRA block. If you wish to do this, insert [format]
and [/format] before and after any code that you wish to reproduce
verbatim with spacing in the fortran model file.</p>
<p>Comments: You can insert comments into your model text file by
starting a line with a capital “C” followed by a space. These lines will
be removed/ignored in the final fortran code.</p>
<div id="pri" class="section level3">
<h3>Primary variables</h3>
<p>Primary variables are the model parameters that are to be estimated
by Pmetrics or are designated as fixed parameters with user specified
values. It should be a list of variable names, one name to a line.
Variable names should be 11 characters or fewer. Some variable names are
<a href="#reserved">reserved</a> for use by Pmetrics and cannot be used
as primary variable names. <strong>The number of primary variables must
be between 2 and 32, with at most 30 random or 20 fixed.</strong></p>
<p>On each row, following the variable name, include the range for the
parameter that defines the search space. These ranges behave slightly
differently for NPAG, IT2B, and the simulator.</p>
<ul>
<li><p>For all engines, the format of the limits is <em>min, max</em>. A
single value will indicate that the parameter is to be fixed but unknown
in the population, i.e. the value is taken as the starting point for the
optimization, but the final value will depend on the model and data and
will be the same across the population. A single value followed by an
“!” will indicate that this value is to be held constant (i.e. fixed and
known) across the population, and not to be estimated.</p></li>
<li><p>For <strong>NPAG</strong>, when <em>min/max</em> limits are
specified, they are absolute, i.e. the algorithm will not search outside
this range.</p></li>
<li><p>For <strong>IT2B</strong>, the range defines the Bayesian prior
distribution of the parameter values for cycle 1. For each parameter,
the mean of the Bayesian prior distribution is taken as the middle of
the range, and the standard deviation is <em>xsig</em>*range (see <a href="\l"><u>IT2B runs</u></a>). Adding a plus sign (+) to a line will
prevent that parameter from being assigned negative values. NPAG and the
simulator will ignore the pluses as the ranges are absolute for these
engines. Note that prior to version 1.5.0, this used to be an
exclamation point (!) but to be consistent throughout the model file,
the exclamation point is now used when fixed values are
desired.</p></li>
<li><p>The <strong>simulator</strong> will ignore the ranges with the
default value of NULL for the <em>limits</em> argument. If the simulator
<em>limits</em> argument is set to NA, which will mean that these ranges
will be used as the limits to truncate the simulation (see <a href="\l"><u>Simulator Runs</u></a>).</p></li>
</ul>
Example:
<div class="script">
<p>#Pri<br />
KE, +0, 5<br />
V, 0.01, 100<br />
KA, 0, 5<br />
KCP, 5<br />
KPC, 0 , 5<br />
Tlag1, 0, 2<br />
IC3, 0, 10000<br />
FA1, 0.5!</p>
</div>
</div>
<div id="cov" class="section level3">
<h3>Covariates</h3>
<p>By default, missing covariate values for subsequent dose events are
linearly interpolated between existing values, or carried forward if the
first value is the only non-missing entry. To suppress interpolation and
carry forward the previous value in a piece-wise constant fashion,
include an exclamation point (!) in any declaration line.</p>
<p><strong>Note</strong> that any covariate relationship to any
parameter may be described as the user wishes by mathematical equations
and Fortran code, allowing for exploration of complex, non-linear,
time-dependent, and/or conditional relationships. This is accomplished
in the <a href="#sec">#Sec</a> block.</p>
<p>Example:</p>
<div class="script">
<p>#Cov<br />
wt<br />
cyp<br />
IC!</p>
</div>
<p>where IC will be piece-wise constant and the other two will be
linearly interpolated for missing values.</p>
</div>
<div id="sec" class="section level3">
<h3>Secondary variables</h3>
<p>Equation syntax must be Fortran. It is permissible to have
conditional statements, but because expressions in this block are
translated into variable declarations in Fortran, expressions other than
of the form &quot;X = function(Y)&quot; must be prefixed by a &quot;&amp;&quot; and contain
only variables which have been previously defined in the Primary,
Covariate, or Secondary blocks. Note that prior to version 1.5.0, the
continuation symbol was “+” before each line, but to avoid confusion
with the use of “+” in the Primary block for IT2B models, and to be
consistent with Fortran notation, the “&amp;” is used henceforth.</p>
<p>Example:</p>
<div class="script">
<p>#Sec<br />
CL = Ke * V * wt**0.75<br />
&amp; IF(cyp .GT. 1) CL = CL * cyp</p>
</div>
</div>
<div id="bol" class="section level3">
<h3>Bolus inputs</h3>
<p>Example:</p>
<div class="script">
<p>#Bol<br />
NBCOMP(1) = 2</p>
</div>
</div>
<div id="ini" class="section level3">
<h3>Initial conditions</h3>
<p>Example:</p>
<div class="script">
<p>#Ini<br />
X(2) = IC*V<br />
X(3) = IC3<br />
</p>
</div>
<p>In the first case, the initial condition for compartment 2 becomes
the value of the IC covariate (defined in #Covariate block) multiplied
by the current estimate of V during each iteration. This is useful when
a subject has been taking a drug as an outpatient, and comes in to the
lab for PK sampling, with measurement of a concentration immediately
prior to a witnessed dose, which is in turn followed by more sampling.
In this case, IC or any other covariate can be set to the initial
measured concentration, and if V is the volume of compartment 2, the
initial condition (amount) in compartment 2 will now be set to the
measured concentration of drug multiplied by the estimated volume for
each iteration until convergence.</p>
<p>In the second case, the initial condition for compartment 3 becomes
another variable, IC3 defined in the #Primary block, to fit in the
model, given the observed data.</p>
</div>
<div id="Fa" class="section level3">
<h3>Fa (bioavailability)</h3>
<p>Specify the bioavailability term, if present. Use the form FA(.) =
expression, where &quot;.&quot; is the input number. Primary and secondary
variables and covariates may be used in the expression, as can
conditional statements in Fortran code. An &quot;&amp;&quot; continuation prefix
is not necessary in this block for any statement, although if present,
will be ignored.</p>
<p>Example:</p>
<div class="script">
<p>#Fa<br />
FA(1) = FA1</p>
</div>
</div>
<div id="lag" class="section level3">
<h3>Lag time</h3>
<p>Example:</p>
<div class="script">
<p>#Lag<br />
TLAG(1) = Tlag1</p>
</div>
</div>
<div id="dif" class="section level3">
<h3>Differential equations</h3>
<p>Example:</p>
<div class="script">
<p>#Dif<br />
XP(1) = -KA*X(1)<br />
XP(2) = RATEIV(1) + KA*X(1) - (KE+KCP)*X(2) + KPC*X(3)<br />
XP(3) = KCP*X(2) - KPC*X(3)</p>
</div>
</div>
<div id="out" class="section level3">
<h3>Outputs</h3>
<p>Output equations, in Fortran format. Outputs are of the form Y(.) =
expression, where &quot;.&quot; is the output equation number. Primary and
secondary variables and covariates may be used in the expression, as can
conditional statements in Fortran code. An &quot;&amp;&quot; continuation prefix
is not necessary in this block for any statement, although if present,
will be ignored. <strong>There can be a maximum of 6 outputs.</strong>
They are referred to as Y(1), Y(2), etc. These equations may also define
a model explicitly as a function of primary and secondary variables and
covariates.</p>
<p>Examples:</p>
<div class="script">
<p>#Out<br />
Y(1) = X(2)/V</p>
<p>#OUT</p>
<p>RES = B(1) * KIN/(KIN-KOUT) * (EXP(-KOUT*TPD)-EXP(-KIN*TPD))</p>
<p>Y(1) = RES/VD</p>
</div>
</div>
<div id="err" class="section level3">
<h3>Error</h3>
<p>Unlike the R6, the error block is separate from the output block. In
Legacy Pmetrics, this block contains all the information Pmetrics
requires for the structure of the error model.</p>
<p>To specify the model in this block, the first line needs to be either
L=number or G=number for a <span class="math inline">\(\lambda\)</span>
or <span class="math inline">\(\gamma\)</span> error model. The number
is the starting value for <span class="math inline">\(\lambda\)</span>
or <span class="math inline">\(\gamma\)</span>. If you include an
exclamation point (!) in the declaration, then <span class="math inline">\(\lambda\)</span> or <span class="math inline">\(\gamma\)</span> will be fixed and not estimated.
Recall that you can only fix <span class="math inline">\(\lambda\)</span> currently to zero.</p>
<p>The next line(s) contain the values for <span class="math inline">\(C0\)</span>, <span class="math inline">\(C1\)</span>, <span class="math inline">\(C2\)</span>, and <span class="math inline">\(C3\)</span>, separated by commas. There should be
one line of coefficients for each output equation. By default Pmetrics
will use values for these coefficients found in the data file. If none
are present or if the model declaration line contains an exclamation
point (!) the values here will be used.</p>
<p>Example 1: estimated <span class="math inline">\(\lambda\)</span>,
starting at 0.4, one output, use data file coefficients but if missing,
use 0.1,0.1,0,0.</p>
<div class="script">
<p>#Err<br />
L=0.4<br />
0.1,0.1,0,0<br />
</p>
</div>
<p>Example 2: fixed <span class="math inline">\(\gamma\)</span> of 2,
two outputs, use data file coefficients but if missing, use 0.1,0.1,0,0
for the first output, but use 0.3, 0.1, 0, 0 for output 2 regardless of
what is in the data file.</p>
<div class="script">
<p>#Err<br />
G=2!<br />
0.1,0.1,0,0<br />
0.3,0.1,0,0!<br />
</p>
</div>
</div>
<div id="extra" class="section level3">
<h3>Extra</h3>
<p>This block is for advanced Fortran programmers only. &lt;span
class=“update&gt;Update</span>It is not yet implemented in R6.
Occasionally, for very complex models, additional Fortran subroutines
are required. They can be placed here. The code must specify complete
Fortran subroutines which can be called from other blocks with
appropriate call functions. As stated earlier, sometimes it is important
to preserve spacing and formatting in Fortran code that you might insert
into blocks, particularly the #EXTRA block. If you wish to do this,
insert [format] and [/format] in the fortran model file around the
affected code.</p>
</div>
<div id="reserved" class="section level3">
<h3>Reserved Names</h3>
<p>The following cannot be used as primary, covariate, or secondary
variable names. They can be used in equations, however.</p>
<table>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Reserved Variable</th>
<th align="left">Function in Pmetrics</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">ndim</td>
<td align="left">internal</td>
</tr>
<tr class="even">
<td align="left">t</td>
<td align="left">time</td>
</tr>
<tr class="odd">
<td align="left">x</td>
<td align="left">array of compartment amounts</td>
</tr>
<tr class="even">
<td align="left">xp</td>
<td align="left">array of first derivative of compartment amounts</td>
</tr>
<tr class="odd">
<td align="left">rpar</td>
<td align="left">internal</td>
</tr>
<tr class="even">
<td align="left">ipar</td>
<td align="left">internal</td>
</tr>
<tr class="odd">
<td align="left">p</td>
<td align="left">array of primary parameters</td>
</tr>
<tr class="even">
<td align="left">r</td>
<td align="left">input rates</td>
</tr>
<tr class="odd">
<td align="left">b</td>
<td align="left">input boluses</td>
</tr>
<tr class="even">
<td align="left">npl</td>
<td align="left">internal</td>
</tr>
<tr class="odd">
<td align="left">numeqt</td>
<td align="left">output equation number</td>
</tr>
<tr class="even">
<td align="left">ndrug</td>
<td align="left">input number</td>
</tr>
<tr class="odd">
<td align="left">nadd</td>
<td align="left">covariate number</td>
</tr>
<tr class="even">
<td align="left">rateiv</td>
<td align="left">intravenous input for inputs when DUR&gt;0 in data
files</td>
</tr>
<tr class="odd">
<td align="left">cv</td>
<td align="left">covariate values array</td>
</tr>
<tr class="even">
<td align="left">n</td>
<td align="left">number of compartments</td>
</tr>
<tr class="odd">
<td align="left">nd</td>
<td align="left">internal</td>
</tr>
<tr class="even">
<td align="left">ni</td>
<td align="left">internal</td>
</tr>
<tr class="odd">
<td align="left">nup</td>
<td align="left">internal</td>
</tr>
<tr class="even">
<td align="left">nuic</td>
<td align="left">internal</td>
</tr>
<tr class="odd">
<td align="left">np</td>
<td align="left">number of primary parameters</td>
</tr>
<tr class="even">
<td align="left">nbcomp</td>
<td align="left">bolus compartment array</td>
</tr>
<tr class="odd">
<td align="left">psym</td>
<td align="left">names of primary parameters</td>
</tr>
<tr class="even">
<td align="left">fa</td>
<td align="left">biovailability</td>
</tr>
<tr class="odd">
<td align="left">tlag</td>
<td align="left">lag time</td>
</tr>
<tr class="even">
<td align="left">tin</td>
<td align="left">internal</td>
</tr>
<tr class="odd">
<td align="left">tout</td>
<td align="left">internal</td>
</tr>
</tbody>
</table>
</div>
<div id="completeEx" class="section level3">
<h3>Complete Example</h3>
<p>Here is a complete example of a model file, as of Pmetrics version
0.40 and higher:</p>
<div class="script">
<p>#Pri<br />
KE, 0, 5<br />
V0, 0.1, 100<br />
KA, 0, 5<br />
Tlag1, 0, 3<br />
</p>
<p>#Cov<br />
wt<br />
C this weight is in kg<br />
</p>
<p>#Sec<br />
V = V0*wt<br />
</p>
<p>#Lag<br />
TLAG(1) = Tlag1<br />
</p>
<p>#Out<br />
Y(1) = X(2)/V<br />
</p>
<p>#Err<br />
L=0.4<br />
0.1,0.1,0,0<br />
</p>
</div>
<p><em>Notes</em>:</p>
<p>By omitting a #Diffeq block with ODEs, Pmetrics understands that you
are specifying the model to be solved algebraically. In this case, at
least KE and V must be in the Primary or Secondary variables. KA, KCP,
and KPC are optional and specify absorption, and transfer to and from
the central to a peripheral compartment, respectively.</p>
<p>The comment line “C this weight is in kg” will be ignored.</p>
</div>
</div>
<div id="updating-models-in-legacy" class="section level2">
<h2>Updating models in Legacy</h2>
<p>The only way to update a model is to edit the text file and copy it
into the working directory to be included in a new run. The advantage is
that it is quick and relatively easy. The disadvantage is that you have
to keep editing, copying and pasting files, and unless your
documentation in R or elsewhere is good, you have no idea how you
changed the model from run to run. In contrast, by using the
<code>$update()</code> method in R6, you can see a written record of how
the model evolved over the project.</p>
</div>
<div id="brief-fortran-tutorial" class="section level2">
<h2>Brief Fortran Tutorial</h2>
<p>Much more detailed help is available from <a href="https://fortran-lang.org/en/learn/quickstart/" class="uri">https://fortran-lang.org/en/learn/quickstart/</a>.</p>
<table>
<thead>
<tr class="header">
<th align="left">Arithmetic Operator</th>
<th align="left">Meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">+</td>
<td align="left">addition</td>
</tr>
<tr class="even">
<td align="left">-</td>
<td align="left">subtraction</td>
</tr>
<tr class="odd">
<td align="left">*</td>
<td align="left">multiplication</td>
</tr>
<tr class="even">
<td align="left">/</td>
<td align="left">division</td>
</tr>
<tr class="odd">
<td align="left">**</td>
<td align="left">exponentiation</td>
</tr>
</tbody>
</table>
<table>
<tbody>
<tr class="odd">
<td align="left"><strong>Relational Operator</strong></td>
<td align="left"><strong>Alternative</strong></td>
<td align="left"><strong>Meaning</strong></td>
</tr>
<tr class="even">
<td align="left">&lt;</td>
<td align="left">.LT.</td>
<td align="left">less than</td>
</tr>
<tr class="odd">
<td align="left">&lt;=</td>
<td align="left">.LE.</td>
<td align="left">less than or equal</td>
</tr>
<tr class="even">
<td align="left">&gt;</td>
<td align="left">.GT.</td>
<td align="left">greater than</td>
</tr>
<tr class="odd">
<td align="left">&gt;=</td>
<td align="left">.GE.</td>
<td align="left">greater than or equal</td>
</tr>
<tr class="even">
<td align="left">==</td>
<td align="left">.EQ.</td>
<td align="left">equal</td>
</tr>
<tr class="odd">
<td align="left">/=</td>
<td align="left">.NE.</td>
<td align="left">not equal</td>
</tr>
</tbody>
</table>
<table style="width:90%;">
<colgroup>
<col width="55%" />
<col width="34%" />
</colgroup>
<tbody>
<tr class="odd">
<td><strong>Selective Execution</strong></td>
<td><strong>Example</strong></td>
</tr>
<tr class="even">
<td>IF (logical-expression) one-statement</td>
<td>IF (T &gt;= 100) CL = 10</td>
</tr>
<tr class="odd">
<td><p>IF (logical-expression) THEN</p>
<p>statements</p>
<p>END IF</p></td>
<td><p>IF (T &gt;= 100) THEN</p>
<p>CL = 10</p>
<p>V = 10</p>
<p>END IF</p></td>
</tr>
<tr class="even">
<td><p>IF (logical-expression) THEN</p>
<p>statements-1</p>
<p>ELSE</p>
<p>statements-2</p>
<p>END IF</p></td>
<td><p>IF (T &gt;= 100) THEN</p>
<p>CL = 10</p>
<p>ELSE</p>
<p>CL = CL</p>
<p>END IF</p></td>
</tr>
</tbody>
</table>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
