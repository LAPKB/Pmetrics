```{r}
#| label: setup
#| echo: false
#| message: false
#| eval: true
library(glue)
library(knitr)

pmetrics <- function(){
    knitr::asis_output("[Pmetrics]{style=\"color: #841010; font-family: 'Arial', Arial, sans-serif; font-weight: 900;\"}")
}


r_help <- function(pkg, name, fn = NULL) {
    if(is.null(fn)) {fn <- name}
    glue::glue("[`{name}`](https://rdrr.io/pkg/{pkg}/man/{fn}.html)")
}

gh_help <- function(name) {
    glue::glue("[`{name}`](https://lapkb.github.io/Pmetrics/reference/{name}.html)")
}
```

First, you must always load the `r pmetrics()` library in your R script or Quarto document.

```{r}
#| eval: false
#| echo: true
library(Pmetrics)
```

```{r}
#| eval: true
#| echo: false
devtools::load_all()
```

# Running NPAG

### Working directory

Next, R and `r pmetrics()` need to know which directory to work in. This is the directory where R expects to find files and where it will save output files. There are two ways to do this.

#### Global working directory change
You can set your working directory with the `r r_help("base", "setwd", "getwd")` function. 
```{r}
#| eval: false
#| echo: true
setwd("/path/to/your/project/directory") # Mac and Linux users
setwd("C:/path/to/your/project/directory") # Windows users
```

**Windows users:** Make sure that you separate directories with a forward slash "/" or double backslashes "\\". Unfortunately, Windows is the only OS that uses backslashes "", so R conforms to Unix/Linux style with the forward slash. If you copy the example below, make sure to change the path to one that exists on your computer.

#### Local path specification
You can also specify the path in a variable and use it in `r pmetrics()` functions without changing the working directory.
```{r}
#| eval: false
#| echo: true
wd <- "/path/to/your/project/directory" # Mac and Linux users
wd <- "C:/path/to/your/project/directory" # Windows users
dat <- PM_data$new(data = file.path(wd, "data", "mydata.csv"))
```

ðŸ’¡ The `r r_help("base", "file.path")` function creates file paths that are compatible with your operating system.

### Workflow

The typical workflow for using `r pmetrics()` is as follows:

1.  Create a `r gh_help("PM_data")` object.
2.  Create a `r gh_help("PM_model")` object.
3.  Fit the model to the data with the `$fit()` method of the model object. This returns a `r gh_help("PM_result")` object, which is also saved to the hard drive and can be loaded later with the `r gh_help("PM_load")` function.
4.  Examine the results with `r gh_help("PM_result")` methods and functions and revise as needed to improve the model fit. This chiefly means using the `$update()` method to change the model or manually editing it.

```{mermaid}
%%| eval: true
flowchart LR

subgraph RSession[" "]
  direction TB
  DATA["PM_data"]
  MODEL["PM_model"]
  RESULT["PM_result"]
end

DISK[("Hard Drive")]

DATA --> MODEL
MODEL -- "$fit()" --> RESULT
RESULT -- "$update()" --> MODEL
DISK -- "PM_load()" --> RESULT
RESULT --> DISK

classDef blue fill:#2f6db6,stroke:#184a8b,color:#fff;
classDef orange fill:#c7662b,stroke:#8a3f18,color:#fff;
classDef disk fill:#d2d3d7,stroke:#7f8084,color:#000;

class DATA,MODEL blue;
class RESULT orange;
class DISK disk;

style RSession fill:#e9f0ff,stroke:#9ab0d6,stroke-width:1px,rx:2,ry:2

```


### Data objects

Pmetrics always needs data and a model to run, so let's create a new data object.

```{r}
#| eval: true
exData <- PM_data$new(data = "../Examples/src/ex.csv")
```

`r pmetrics()` standardizes the data, checks for errors, and provides an error and attempted fix report fo any found.

You can look at a .csv data file directly by opening it in a spreadsheet program like Excel, or a text editor.

`exData` is an `r r_help("R6", "R6", "R6Class")` object, which means that contains both data and methods to process that data.

```{r}
exData # prints the object, usually to the terminal, but in this case to a rendered "lite" spreadsheet
exData$data # contains your original data
exData$standard_data # contains the standardized and validated data
exData$summary() # prints the summary of the data to the terminal
```

Most `r pmetrics()` objects are R6 objects, so you can use the `$` operator to access their data and methods. Many of them have a `summary()` method that prints a summary of the object to the console and a `plot()` method that creates a plot of the object. See `r gh_help("PM_data")` for more information on the `PM_data` class and its methods.

**Note:** We recognize that many users are familiar with the "S3 framework" in R, which uses functions like `summary(object)` and `plot(object)`. To comply with better programming standards, `r pmetrics()` uses the R6 framework. However, we have provided S3 methods for most functions, so you can use `summary(object)` and `plot(object)` if you prefer.

```{r}
# S3 method to summarize data
summary(exData)
```

`PM_data` has a `plot()` method that creates a plot of the data. See `r gh_help("plot.PM_data")`  for more information.

```{r}
#| eval: false
exData$plot() 
```

```{r}
#| eval: true
#| echo: false
p <- exData$plot()
plotly::plotly_build(p) #needed to display in output
```

### Model objects

You can specify a model by reading a file or directly as a list object in R. We'll do both.

The following code creates the same model as in `/src/model.txt` file. See further [model details](https://lapkb.github.io/Pmetrics/articles/models.html) on creating models in R compared to text files. The advantage of creating them in R is that one does not need to copy model files into folders to provide necessary inputs.

```{r}
#| label: mod1_def
#| eval: true
mod1 <- PM_model$new(
  pri = list(
    Ka = ab(0.1, 0.9),
    Ke = ab(0.001, 0.1),
    V = ab(30, 120),
    lag1 = ab(0, 4)
  ),
  cov = list(
    wt = interp(),
    africa = interp("none"),
    age = interp(),
    gender = interp("none"),
    height = interp()
  ),
  eqn = function(){
    two_comp_bolus
  },
  lag = function(){
    lag[1] = lag1
  },
  out = function(){
  Y[1] = X[2]/V
  },
  err = list(
    proportional(5, c(0.02, 0.05, -0.0002, 0))
  )
)
```

When you execute the above code in your own script or Quarto document, you will see a message indicating that the model has compiled.

```{r}
#| eval: true
mod1 # prints the model object
```

```{r}
#| eval: true
#| message: false

mod1$plot() 
```

We have another file "model.txt" that contains the old representation of the same model we coded above, let's take a look at it.

```{r}
#| eval: true
system("cat ../Examples/src/model.txt")
```

You can also open it in a text editor.

`PM_model$new()` also accepts the path to a model file to create the same model using the file.

```{r}
mod1b <- PM_model$new("../Examples/src/model.txt")
mod1b # look at it
```

PM_model provides a method to update the different elements of a model, for example:

```{r}
mod1b$update(
  pri = list(
    ka = ab(0.001, 5)
))
```

It is case sensitive, so ka is different from Ka. To remove a parameter, set it to NULL.

To copy a model use the `$clone()` method.

```{r}
mod1b <- mod1$clone()
```

Simply using `mod1b <- mod1` will cause `mod1b` to be changed if `mod1` is changed, as R6 objects use reference semantics. For more details you can refer to [Advanced R](https://adv-r.hadley.nz/r6.html), Section 14.4.

Lastly, `r pmetrics()` has a model building app!

```{r}
#| eval: false
build_model() #start from scratch
build_model(exData) #start with data to match covariates
build_model(mod1) #start with a model and update it
```

### Fit the model to the data

To keep everything tidy, we are working in a folder specifically to store the runs. We are specifying the path in the call to `$fit()` rather than globally changing the working directory.

```{r}
#| eval: false
run1 <- mod1$fit(data = exData, run = 1, overwrite = TRUE, path = "../Examples/Runs") 
```

The `r gh_help("PM_model")` class has a `$fit()` method that fits the model to the data.
```{r}
#| eval: true
#| echo: false
run1 <- NPex
```

After the run is complete the results are returned to the assigned object, here 'run1'. However, if you want to load the results later, you can use the `PM_load()` function. Runs will be sequentially numbered as /1, /2, /3,... in your working directory.

```{r}
#| eval: false
run1 <- PM_load(1, path = "../Examples/Runs") # load the results from run 1 if returning to this script later
```

